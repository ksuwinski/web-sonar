<html>
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    </head>
    <button id="button-start">Start</button>
    <body>
        <div>
            <canvas id="myChart"></canvas>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script type="module">
            let impulseLength = 512;
            let fc = 17000;
            let B = 4000;

            const clutterPlotCanvas = document.getElementById("myChart");
            const clutterPlot = new Chart(clutterPlotCanvas, {
                type: "line",
                data: {
                    // labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                    labels: [...Array(impulseLength / 8).keys()],
                    datasets: [
                        {
                            label: "clutter amplitude",
                            data: [1, 2, 3, 4, 5, 6],
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    // animation: false,
                    scales: {
                        y: {
                            // min: 0,
                            // max: 100,
                            // beginAtZero: true,
                        },
                    },
                },
            });

            const buttonStart = document.getElementById("button-start");

            let started = false;
            let audioContext = undefined;
            buttonStart.addEventListener("click", async () => {
                if (started) {
                    audioContext.suspend();
                    started = false;
                    buttonStart.innerHTML = "start";
                    return;
                }
                started = true;
                audioContext = new AudioContext({ latencyHint: "playback" });

                const response = await fetch(
                    "/pkg/sonar_bg.wasm?idk=" +
                        Math.round(Math.random() * 1000000),
                );
                const wasm_blob = await response.arrayBuffer();

                const fs = audioContext.sampleRate;
                fc = fs / Math.round(fs / fc);
                console.log("fs = %f", fs);

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        autoGainControl: false,
                        echoCancellation: false,
                        noiseSuppression: false,
                        voiceIsolation: false,
                        channelCount: 2,
                        sampleRate: 44100,
                    },
                });
                const micSource = audioContext.createMediaStreamSource(stream);

                const audioTrack = stream.getAudioTracks()[0];
                console.log(audioTrack.getSettings());

                await audioContext.audioWorklet.addModule("sonar-processor.js");
                const sonarProcessor = new AudioWorkletNode(
                    audioContext,
                    "sonar-processor",
                    {
                        numberOfInputs: 1,
                        numberOfOutputs: 0,
                    },
                );
                sonarProcessor.port.onmessage = (ev) => {
                    console.log(ev.data);
                    clutterPlot.data.datasets[0].data = ev.data.clutter;
                    clutterPlot.update();
                };
                micSource.connect(sonarProcessor);

                const T = impulseLength / fs;
                const f0 = fc - B / 2;
                const f1 = fc + B / 2;
                const myArrayBuffer = audioContext.createBuffer(
                    2,
                    impulseLength * 512,
                    fs,
                );
                const channelBuffer = myArrayBuffer.getChannelData(0);
                for (let n = 0; n < 512; n++) {
                    for (let i = 0; i < impulseLength; i++) {
                        const phase =
                            ((2 * Math.PI * (-f0 * f1 * T)) / B) *
                            Math.log(1 - (B / (f1 * T)) * (i / fs));
                        const win =
                            0.5 *
                            (1 - Math.cos((2 * Math.PI * i) / impulseLength)); //Hann window
                        channelBuffer[i + n * 512] = Math.sin(phase) * win;
                    }
                }
                sonarProcessor.port.postMessage({
                    wasm_blob,
                    chirp: channelBuffer.subarray(0, impulseLength),
                    normalizedCarrier: fc / fs,
                });

                const chirpSource = audioContext.createBufferSource();
                chirpSource.buffer = myArrayBuffer;
                chirpSource.loop = true;

                chirpSource.connect(audioContext.destination);
                chirpSource.start();

                buttonStart.innerHTML = "stop";
            });
        </script>
    </body>
</html>
